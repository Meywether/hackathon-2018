<!doctype html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		  content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

	<title>VOTE ME ❤❤❤</title>

	<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
	<link type="text/css" rel="stylesheet" href="css/vis.min.css">

	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/vis.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	<script>
		const maxAnzahlPersonen = 20;

		let panicTimeout;

		let persons = [];
		let lightsInside = [];
		let temperaturesInside = [];

		$(function () {
			$.get('/api/all', (data) => {
				let socket = io();

				const persons = data.persons;
				const lightsInside = data.lightsInside;
				const temperaturesInside = data.temeratureInside;


				//***********************************
				// PERSONEN
				//***********************************
				const personsDataset = new vis.DataSet();
				const personsGraph = new vis.Graph2d(document.getElementById('persons'), personsDataset, {
					//start: persons[0].timestamp,
					//end: persons[persons.length-1].timestamp,
					moveable: false,
					zoomable: false,
					showCurrentTime: false,
					interpolation: false,
					dataAxis: {
						left: {
							range: {
								min: 0,
								max: 100
							}
						}
					}
				});

				for (let i = persons.length - 31; i < persons.length; i++) {
					if (!persons[i]) {
						continue;
					}

					personsDataset.add({
						id: i,
						x: persons[i].timestamp,
						y: persons[i].currPersons / maxAnzahlPersonen * 100
					});
				}

				function updateGraph() {
					personsGraph.setWindow(vis.moment(personsDataset.min('x').x).subtract(5, 'minutes'), vis.moment(personsDataset.max('x').x).add(5, 'minutes'));
					$('#max').text(maxAnzahlPersonen);
					$('#currentlyUsed').text(persons[persons.length-1].currPersons);
				}
				updateGraph();

				//***********************************
				// TEMPERATUR
				//***********************************
				$('#temperatur').text(temperaturesInside[temperaturesInside.length-1].payload);

				//***********************************
				// SOCKET SHIZZL
				//***********************************
				socket.on('person', (person) => {
					persons.push(person);
					personsDataset.add({
						id: persons.length-1,
						x: person.timestamp,
						y: person.currPersons / maxAnzahlPersonen * 100
					});
					if(persons.length > 30) {
						personsDataset.remove(personsDataset.min('x').id);
					}
					updateGraph();
				});

				socket.on('temperatureInside', (temperatureInside) => {
					temperaturesInside.push(temperatureInside);
				});

				socket.on('lightsInside', (lightInside) => {
					lightsInside.push(lightInside);
				});

				socket.on('log', (payload) => {
					let newMsg = $('<span>').addClass('d-block').text(`${payload.from}: ${payload.message}`);
					$('#log').prepend(newMsg);
				});

				socket.on('PANIC', () => {
					$('#panic').show();
					clearTimeout(panicTimeout);
					panicTimeout = setTimeout(() => {
						$('#panic').hide();
					}, 3000);
				});
			});
		});
	</script>

	<style>
		#panic {
			position: fixed;
			top: 0;
			left: 0;
			background: red;
			width: 100vw;
			height: 100vh;
			line-height: 100vh;
			font-size: 20vmin;
			color: #fff;
			text-shadow: 5px 5px #000;
			text-align: center;
			display: none;
			font-weight: bold;
			z-index: 999999;
		}

		#panic span {
			font-size: 20pt;
			text-shadow: 2px 2px #000;
		}

		#temperatur:after {
			content: '°C';
		}
	</style>
</head>
<body>
<div id="panic">
	PANIC!
	<span>(at the disco)</span>
</div>

<div class="jumbotron">
	<div class="container">
		<h1 class="display-4">Smart Public Transportation</h1>
		<p class="lead">Make St. Pölten great (again)!</p>
	</div>
</div>

<div class="container">
	<div class="row">
		<div class="col-8">
			<h3 class="mb-3">Auslastung in % <small>(max: <span id="max">--</span> Personen)</small></h3>
			<div id="persons"></div>
		</div>
		<div class="col-4">
			<h3 class="mb-3">Temperatur im Bus:</h3>
			<h1 id="temperatur" class="display-1">0</h1>

			<h3 class="mb-3 mt-4">Derzeit besetzt:</h3>
			<h1 id="currentlyUsed" class="display-1">0</h1>

			<!--<h3 class="mb-3 mt-4">Kompass:</h3>
			<div id="compass">
				<img id="compass-needle" src="img/autobus.png" draggable="false" alt="Brum brum">
			</div>-->
		</div>
	</div>

	<div class="row" style="margin-top:100px;">
		<div class="col-12">
			<h3>Logs</h3>
			<pre class="pre-scrollable">
				<code id="log"></code>
			</pre>
		</div>
	</div>
</div>
</body>
</html>
